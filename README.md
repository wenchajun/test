## fluent测试
测试环境：

主机：亚太二区-A云主机 8核16G

操作系统：Ubuntu Server 18.04.5 LTS 64bit

ks集群：All-In-One

镜像仓库：DockerHub公有云仓库

测试条件：安装Kubesphere集群，启用组件 `logging`、`events` 及 `auditing`组件，监控日志，并将fluent-bit升级为1.7.3

测试范围：对fluent-bit1.7.3日志收集及其兼容性进行测试

测试内容：
fluentd 是日志收集器，处理器和聚合器。
fluent-Bit 是一个日志收集器和处理器（它没有 fluentd 等强大的聚合功能）。
测试fluent-bit 具体性能

测试步骤：1.编写测试代码

2.编写dockerfile，打包镜像

3.push到Dockerhub，再在KubeSphere集群中pull下来，开启pod

4.运行测试镜像，修改fluent-bit的yaml文件，让fb接收信息，测试fb的功能

4.1测试的点：启动单个pod，测试每秒输出5个，50个，500个，5000个，逐渐增加，查看fluent能否承受这么大的压力

4.2启动多个pod，查看fluent能否承受这么大的压力

4.3测试关注web前端的资源使用量

4.4fluent能测，那么es能支撑这种访问量吗


预期结果：获取fluent-bit接收日志的最大值，了解fluent-bit的具体性能

测试情况：

### 测试1：测试默认状态下fluent-bit：v1.7.3性能

本次测试将flunt-bit中的工作负载日志中的 `Input.Spec.Tail.ExcludePath` 字段设置为 `/var/log/containers/*_kube*-system_*.log`，以排除系统组件的全部日志。

在这里N设置为每秒的输出数，M为每行信息速率速率将M设置为2即打印一次打印四个信息

```
name:eloncheng||fluent-bit-test|The current number is4579name:eloncheng||fluent-bit-test|The current number is4579name:eloncheng||fluent-bit-test|The current number is4579name:eloncheng||fluent-bit-test|The current number is4579

```

集群web前端收集的情况为

```
2021-05-25 03:30:43.879746575 +0000 kube.var.log.containers.fb-test-pod_fb-test_fb-test01-05e2adc06517097807dad089caff29425a7e28fe4d6f7c808b6c0964cd5781af.log: {"log":"name:eloncheng||fluent-bit-test|The current number is1856369name:eloncheng||fluent-bit-test|The current number is1856369name:eloncheng||fluent-bit-test|The current number is1856369name:eloncheng||fluent-bit-test|The current number is1856369\n","time":"2021-05-25T03:30:43.879746575Z","kubernetes":{"pod_name":"fb-test-pod","namespace_name":"fb-test","container_name":"fb-
```

在测试代码的编写上，在协程性能上考虑了加了锁（有序）以及未加锁（乱序）的两个版本，对加锁的程序进行测试：

|                                                | 耗时                  |
| ---------------------------------------------- | --------------------- |
| 每秒打印1000次（打印了11411条日志）            | 10870938纳秒/1000条   |
| 每秒打印1500次（打印了106099条日志）           | 2411190154纳秒/1500条 |
| 每秒打印1000次（打印了117581条日志）（未加锁） | 229106纳秒/1000条     |
| 每秒打印1500次（打印了91429条日志）（未加锁）  | 3329690纳秒/1500条    |

​       因1s=1000000000纳秒，故以上日志耗时满足在一秒内，故在每秒1000内应选择加锁的协程进行并发输出，以便查看，而每秒大于1000应选择无锁的版本。在以上基础上固定输出信息不变，调整每秒输出N的大小，每10分钟统计一次，记录日志收集状况。

​       在这里容器组自身会打印一份日志信息回显至console端，项目为fb-test,容器组为fb-test-pod，该日志为容器自身打印的日志；而fluentd会收集并打印一份信息，项目为default，容器组为fluentd-6589496b8-7dk5t，所以近10分钟收集信息会是输出的两倍信息，而日志记录会记录收集了两个容器信息。

|                                         | 每秒输出5次日志      | 每秒输出50次日志    | 每秒输出500次日志           | 每秒输出700次日志        |
| --------------------------------------- | -------------------- | ------------------- | --------------------------- | ------------------------ |
| 测试程序实际打印                        | 8                    | 52                  | 502                         | 702                      |
| 10分钟内共有（容器内部）                | 4800                 | 31460               | 301702                      | 421902                   |
| 10分钟内共有（fluentd）                 | 4800                 | 31460               | 301200                      | 422799                   |
| 平均每秒收集(容器)                      | 8                    | 52.4                | 502.83                      | 703.17                   |
| 平均每秒收集（fluentd）                 | 8                    | 52.4                | 502                         | 704.6                    |
| fluent-bit资源使用情况（CPU）           | 3-4m                 | 11m                 | 75-79m                      | 0.11-0.12core            |
| fluent-bit资源使用情况（内存）          | 27.45Mi              | 28.84Mi             | 32.07-41.08                 | 47.59-53.66              |
| fluent-bit资源使用情况（网络流出/流入） | 171.69Kbps/29.26Kbps | 1.13Mbps/192.06Kbps | 12.17Mbps/1.65Mbps          | 16.13-17.33Mbps/2.49Mbps |
| fluentd资源使用情况（CPU）              | 1m                   | 4-5m                | 39-42m                      | 54-72m                   |
| fluentd资源使用情况（内存）             | 68.27Mi              | 69.43Mi             | 106.8Mi                     | 120.07-129.48Mi          |
| fluentd资源使用情况（网络流出/流入）    | 802.84bps/74.87kbps  | 1.72Kbps/544.36Kbps | 6.94-7.73Kbps/5.07-5.51Mbps | 9.48kbps/7.93Mbps        |

|                                         | 每秒输出800次日志        | 每秒输出900次日志             | 每秒输出1000次日志       |
| --------------------------------------- | ------------------------ | ----------------------------- | ------------------------ |
| 测试程序实际打印                        | 802                      | 902                           | 1002                     |
| 10分钟内共有（容器内部）                | 482002                   | 537739                        | 589809                   |
| 10分钟内共有（fluentd）                 | 401902                   | 372161                        | 343050                   |
| 平均每秒收集(容器内部)                  | <u>803.3</u>             | <u>896.23</u>                 | <u>983.015</u>           |
| 平均每秒收集（fluentd）                 | <u>669.8</u>             | <u>620.26</u>                 | <u>571.75</u>            |
| fluent-bit资源使用情况（CPU）           | 0.1-0.12core             | 0.1-0.11core                  | 0.1-0.11core             |
| fluent-bit资源使用情况（内存）          | 33.02-41.82Mi            | 42.46-49.04                   | 31.13-36.53Mi            |
| fluent-bit资源使用情况（网络流出/流入） | 16.51-17.97Mbps/2.66Mbps | 15.67-17.89Mbps/2.38-2.73Mbps | 16.23-17.44Mbps/2.66Mbps |
| fluentd资源使用情况（CPU）              | 68-79m                   | 62-66m                        | 63-78m                   |
| fluentd资源使用情况（内存）             | 137.25Mi                 | 138.8Mi                       | 138.67Mi                 |
| fluentd资源使用情况（网络流出/流入）    | 7.63-8.93Kbps/7.42Mbps   | 9.14-11.41Kbps/7.41Mbps       | 7.46-8.61Kbps/8.07Mbps   |

从上表可以看出，每秒输出700后日志就丢失严重，fluent-bit的CPU资源使用情况一直在0.1-0.12core之间，并未随着每秒输入日志次数的增加而增加，故当某一容器在一时输出大量日志时，可以通过调整fluent-bit的CPU限制来及时获取实时日志。

### 测试2：减少信息输出，测试fluent-bit：v1.7.3性能

为了进一步测试，将输出信息减少，改为输出单行，即将每次输出信息降为原来的1/4，对比来查看flunet-bit情况，日志打印信息如下

```
name:eloncheng||fluent-bit-test|The current number isxxx
```

flunentd接受信息如下：

```
2021-05-26 05:28:48.382849850 +0000 kube.var.log.containers.fb-test-pod_fb-test_fb-test01-18b9b63288cdbd0446134799423b06e9d0c3541e2baacccd729035f92c879d7a.log: {"log":"name:eloncheng||fluent-bit-test|The current number isxxxx\n","time":"2021-05-26T05:28:48.38284985Z","kubernetes":{"pod_name":"fb-test-pod","namespace_name":"fb-test","container_name":"fb-test01","docker_id":"3e767d61a3dcdb96898d09ef97ff463fa0120e463f36ee12aaf195ad4a365dcd","container_image":"wenchajun/test:v0.6"}}
```

打印日志记录如下：

|                                         | 每秒输出50次日志      | 每秒输出500次日志  | 每秒输出800次日志     | 每秒输出900次日志        |
| --------------------------------------- | --------------------- | ------------------ | --------------------- | ------------------------ |
| 测试程序实际打印                        | 52                    | 502                | 802                   | 902                      |
| 10分钟内共有（容器内部）                | 31200                 | 301200             | 482002                | 541200                   |
| 10分钟内共有（fluentd）                 | 31200                 | 301200             | 480804                | 541200                   |
| 平均每秒收集(容器)                      | 52                    | 502                | 803.3                 | 902                      |
| 平均每秒收集（fluentd）                 | 52                    | 502                | 801.34                | 902                      |
| fluent-bit资源使用情况（CPU）           | 9-10m                 | 62-69m             | 0.09-0.1core          | 0.11core                 |
| fluent-bit资源使用情况（内存）          | 47.87Mi               | 47.84-56.71Mi      | 48.01-50.54           | 38.11-45.66              |
| fluent-bit资源使用情况（网络流出/流入） | 0.92-1Mbps/195.06Kbps | 9.09Mbps/1.79MKbps | 15.55Mbps/2.5Mbps     | 15.67-16.68Mbps/3.09Mbps |
| fluentd资源使用情况（CPU）              | 4-5m                  | 38m                | 67-74m                | 69-86m                   |
| fluentd资源使用情况（内存）             | 139.28Mi              | 138.93Mi           | 136.39Mi              | 135.48Mi                 |
| fluentd资源使用情况（网络流出/流入）    | 2.16Kbps/437.96Kbps   | 4.72Kbps/4.03Mbps  | 8.7Kbps/5.94-6.87Mbps | 11.23kbps/7.56Mbps       |

|                                         | 每秒输出1000次日志       | 每秒输出1100次日志            |
| --------------------------------------- | ------------------------ | ----------------------------- |
| 测试程序实际打印                        | 1002                     | 902                           |
| 10分钟内共有（容器内部）                | 602202                   | 661200                        |
| 10分钟内共有（fluentd）                 | 560636                   | 535364                        |
| 平均每秒收集(容器内部)                  | <u>1003.67</u>           | <u>1102</u>                   |
| 平均每秒收集（fluentd）                 | <u>934.39</u>            | <u>892.3</u>                  |
| fluent-bit资源使用情况（CPU）           | 0.11-0.12core            | 0.11-0.12core                 |
| fluent-bit资源使用情况（内存）          | 26.13-30.53Mi            | 25.86-34.16                   |
| fluent-bit资源使用情况（网络流出/流入） | 16.51-18.44Mbps/2.76Mbps | 16.67-17.89Mbps/2.88-3.23Mbps |
| fluentd资源使用情况（CPU）              | 78-87m                   | 68-81m                        |
| fluentd资源使用情况（内存）             | 150.25Mi                 | 147.8Mi                       |
| fluentd资源使用情况（网络流出/流入）    | 6.63-7.93Kbps/7.82Mbps   | 8.44-9.41Kbps/7.61Mbps        |

从这次测试中我们可以看出虽然将每次打印信息的数据量降为原来的1/4，但是每秒打印超过1000条的情况下，日志仍然丢失严重。主要原因在于CPU限制。

### 测试3：同时启动多个pod，测试fluent-bit：v1.7.3性能

对于多个Pod测试，在本次测试中，我们使用Deployment创建2个pod，控制pod中每个容器的打印速率，观察日志打印状态。在本次测试中信息输出大小为测试2中的大小。

|                                         | 每秒输出50次日志         | 每秒输出300次日志  | 每秒输出400次日志   | 每秒输出500次日志        |
| --------------------------------------- | ------------------------ | ------------------ | ------------------- | ------------------------ |
| 测试程序实际打印                        | 52*2=104                 | 302*2=604          | 402*2=804           | 502*2=1004               |
| 10分钟内共有（容器内部）                | 62088                    | 363004             | 482400              | 602400                   |
| 10分钟内共有（fluentd）                 | 62296                    | 364939             | 481120              | 531257                   |
| 平均每秒收集(容器)                      | 103.48                   | 605                | 804                 | <u>1004</u>              |
| 平均每秒收集（fluentd）                 | 103.82                   | 608.2              | 801.9               | <u>885.4</u>             |
| fluent-bit资源使用情况（CPU）           | 17-18m                   | 81-84m             | 0.1core             | 0.11-0.12core            |
| fluent-bit资源使用情况（内存）          | 21.87Mi                  | 28.13-30.31Mi      | 24.38-30.31Mi       | 26.59-30.66              |
| fluent-bit资源使用情况（网络流出/流入） | 1.87-2.09Mbps/394.06Kbps | 12.09Mbps/2.2MKbps | 15.88Mbps/2.68MKbps | 16.37-18.68Mbps/3.39Mbps |
| fluentd资源使用情况（CPU）              | 8-9m                     | 42m                | 60-71m              | 69-78m                   |
| fluentd资源使用情况（内存）             | 145.28Mi                 | 144.93Mi           | 145.27Mi            | 143.48Mi                 |
| fluentd资源使用情况（网络流出/流入）    | 2.96Kbps/858.96Kbps      | 10.72Kbps/4.73Mbps | 8.72Kbps/7.73Mbps   | 10.23kbps/8.06Mbps       |

|                                         | 每秒输出550次日志  | 每秒输出600次日志  |
| --------------------------------------- | ------------------ | ------------------ |
| 测试程序实际打印                        | 552*2=1004         | 602*2=1204         |
| 10分钟内共有（容器内部）                | 662400             | 723604             |
| 10分钟内共有（fluentd）                 | 494752             | 474423             |
| 平均每秒收集(容器)                      | <u>1104</u>        | <u>1206.00</u>     |
| 平均每秒收集（fluentd）                 | <u>824.6</u>       | <u>790.75</u>      |
| fluent-bit资源使用情况（CPU）           | 0.11-0.12core      | 0.11-0.12core      |
| fluent-bit资源使用情况（内存）          | 30.87-38.02Mi      | 26.87-31.02Mi      |
| fluent-bit资源使用情况（网络流出/流入） | 17.39Mbps/3.35Mbps | 17.09Mbps/3.58Mbps |
| fluentd资源使用情况（CPU）              | 80m                | 82m                |
| fluentd资源使用情况（内存）             | 148.28Mi           | 144.28Mi           |
| fluentd资源使用情况（网络流出/流入）    | 9.41Kbps/7.17Mbps  | 10.21Kbps/8.01Mbps |

故在单节点中，开启多个pod，每秒输出日志的总量并不会得到提升。

### 测试4：调整参数以确保信息不丢失

通过调整输出，将输出信息一次发送一条，1秒钟发送1000条，1秒钟发送1500条的情况下，查看elasticsearch-logging-data-0和1中es容器的资源使用情况，发现1s发送1000条资源使用量为0.29core，而1秒发送1500条情况下资源使用量为0.29-0.32core，内存消耗为2.29G，且es容器资源限制为CPU：4，初步排除es性能不够的影响，通过调整fluent-bit的CPU来查看日志收集情况

编辑配置文件fluent-bit.yaml,在spec.resouces中修改，具体信息为

```
resources:
    limits:
      cpu: 300m
      memory: 500Mi
     requests:
       cpu: 20m
       memory: 50Mi
```



|                   | 测试程序实际打印 | 10分钟内共有（容器内部） | 10分钟内共有（fluentd） | 平均每秒收集(容器) | 平均每秒收集（fluentd） | fluent-bit资源使用情况（CPU） | fluent-bit资源使用情况（内存） | fluent-bit资源使用情况（网络流出/流入） |
| ----------------- | ---------------- | ------------------------ | ----------------------- | ------------------ | ----------------------- | ----------------------------- | ------------------------------ | --------------------------------------- |
| 每秒输出800次日志 | 802              | 481147                   | 403001                  | <u>801.9</u>       | <u>671.66</u>           | 0.1-0.11core                  | 24-30Mi                        | 17.99Mbps/2.58Mbps                      |

修改CPU限制仍然导致日志丢失，通过查看fluentd工作原理，如图所示，![](https://github.com/wenchajun/test/blob/master/images/1%20(2).png)

判断可能是数据来不及收集，于是修改Input.spec.tail.memBufLimit,将其默认值5MB改为20MB，该值为将数据追加到引擎时的内存限制。如果达到此限制，它将被暂停；刷新数据后，它将恢复。为了保障数据能及时传递，将每秒2000次日志设置为30MB，每秒2500次日志设置为60MB。在这数据输出大小采用测试1中的数据，在测试1中，数据达到每秒800条就已不能及时获取全部信息，所以从800开始测试。

|                                         | 800/s              | 1000/s              | 1500/s                   | 2000/s                   | 2500/s                   |
| --------------------------------------- | ------------------ | ------------------- | ------------------------ | ------------------------ | ------------------------ |
| 测试程序实际打印                        | 802                | 1002                | 1502                     | 2002                     | 2502                     |
| 10分钟内共有（容器内部）                | 477190             | 602202              | 901200                   | 1201200                  | 1489695                  |
| 10分钟内共有（fluentd）                 | 473539             | 602589              | 900747                   | 1154136                  | 1289339                  |
| 平均每秒收集(容器)                      | 795.316            | 1003.27             | 1502                     | 2002                     | <u>2482.8</u>            |
| 平均每秒收集（fluentd）                 | 795.3              | 1004.31             | 1501.24                  | 1923.56                  | <u>2148.89</u>           |
| fluent-bit资源使用情况（CPU）           | 0.11-0.12core      | 0.14-0.15core       | 0.21-0.22core            | 0.26-0.29core            | 0.32-0.35core            |
| fluent-bit资源使用情况（内存）          | 21.8-31.37Mi       | 51.84-55.71Mi       | 46.01-63.54Mi            | 58.11-88.66Mi            | 51.11-72.66Mi            |
| fluent-bit资源使用情况（网络流出/流入） | 20.21Mbps/2.87Mbps | 24.09Mbps/3.59MKbps | 35.55Mbps/5.5Mbps        | 41.67-46.68Mbps/7.09Mbps | 49.67-64.68Mbps/9.09Mbps |
| fluentd资源使用情况（CPU）              | 72-77m             | 87-88m              | 0.14-0.15core            | 0.16-0.17core            | 0.19-0.21core            |
| fluentd资源使用情况（内存）             | 139.28Mi           | 154.93Mi            | 212.39Mi                 | 265.48Mi                 | 275.48Mi                 |
| fluentd资源使用情况（网络流出/流入）    | 8.05Kbps/8.96Kbps  | 10.72Kbps/10.32Mbps | 20.7Kbps/15.94-17.87Mbps | 25.23kbps/20.56Mbps      | 30.23kbps/26.56Mbps      |

可以看到，调整大小后，fluent-bit性能得到了明显改善，而信息发送到达每秒2000条后，日志遗失率约为3.91%，每秒发送2500条时，日志遗失率为13.68%。所以当每秒日志量过大时，可以通过调整Input.spec.tail.memBufLimit来收集信息。
