## fluent测试
测试环境：

主机：亚太二区-A云主机 8核16G

操作系统：Ubuntu Server 18.04.5 LTS 64bit

ks集群：All-In-One

镜像仓库：DockerHub公有云仓库

测试条件：安装Kubesphere集群，启用组件 `logging`、`events` 及 `auditing`组件，监控日志，并将fluent-bit升级为1.7.3

测试范围：对fluent-bit1.7.3日志收集及其兼容性进行测试

测试内容：
测试fluent-bit：v1.7.3 具体性能

测试步骤：1.编写测试代码

2.编写dockerfile，打包镜像

3.push到Dockerhub，再在KubeSphere集群中pull下来，开启pod

4.运行测试镜像，修改fluent-bit的yaml文件，让fb接收信息，测试fb的功能

4.1测试的点：启动单个pod，测试每秒输出5个，50个，500个，5000个，逐渐增加，查看fluent能否承受这么大的压力

4.2启动多个pod，查看fluent能否承受这么大的压力

4.3测试关注web前端的资源使用量

4.4fluent能测，那么es能支撑这种访问量吗


预期结果：获取fluent-bit接收日志的最大值，了解fluent-bit的具体性能

测试情况：

### 测试1：测试默认状态下fluent-bit：v1.7.3性能

本次测试将flunt-bit中的工作负载日志中的 `Input.Spec.Tail.ExcludePath` 字段设置为 `/var/log/containers/*_kube*-system_*.log`，以排除系统组件的全部日志。

在这里N设置为每秒的输出数，M为每行信息速率速率将M设置为2即打印一次打印四个信息，输出225字节。

```
name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100

```

集群web前端收集的情况为

```
2021-05-25 03:30:43.879746575 +0000 kube.var.log.containers.fb-test-pod_fb-test_fb-test01-05e2adc06517097807dad089caff29425a7e28fe4d6f7c808b6c0964cd5781af.log: {"log":"name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100name:eloncheng||fluent-bit-test|The current number is100\n","time":"2021-05-25T03:30:43.879746575Z","kubernetes":{"pod_name":"fb-test-pod","namespace_name":"fb-test","container_name":"fb-
```

​       在这里容器组自身会打印一份日志信息回显至console端，项目为fb-test,容器组为fb-test-pod，该日志为容器自身打印的日志；而fluentd会收集并打印一份信息，项目为default，容器组为fluentd-6589496b8-7dk5t，所以近10分钟收集信息会是输出的两倍信息，而日志记录会记录收集了两个容器信息。

|                          | 每秒输出8次日志 | 每秒输出52次日志 | 每秒输出500次日志 | 每秒输出570次日志 |
| ------------------------ | --------------- | ---------------- | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 4800            | 31460            | 30000             | 34200             |
| 10分钟内共有（fluentd）  | 4800            | 31460            | 30000             | 34200             |
| 平均每秒收集(容器)       | 8               | 52.4             | 500               | 600               |
| 平均每秒收集（fluentd）  | 8               | 52.4             | 500               |                   |
| 每秒输出数据量           | 1.76KB          | 11.4kb           | 109.9Kb           |                   |

|                          | 每秒输出585次日志 | 每秒输出592次日志 | 每秒输出600次日志 |
| ------------------------ | ----------------- | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 35100             | 35200             | 360000            |
| 10分钟内共有（fluentd）  | 35100             | 35200             | 357082            |
| 平均每秒收集(容器内部)   |                   | 600               | 700               |
| 平均每秒收集（fluentd）  |                   | 589.165           | 676.87            |
| 每秒输出数据量           |                   | 131.83kb          | 153.8kb           |

从上表可以看出，每秒输出700后日志就丢失严重，fluent-bit的CPU资源使用情况一直在0.1-0.12core之间，并未随着每秒输入日志次数的增加而增加，故当某一容器在一时输出大量日志时，可以通过调整fluent-bit的CPU限制来及时获取实时日志。

### 测试2：减少信息输出，测试fluent-bit：v1.7.3性能

为了进一步测试，将输出信息减少，改为输出单行，即将每次输出信息降为原来的1/4，为57字节，对比来查看flunet-bit情况，日志打印信息如下

```
name:eloncheng||fluent-bit-test|The current number is 100
```

flunentd接受信息如下：

```
2021-05-26 05:28:48.382849850 +0000 kube.var.log.containers.fb-test-pod_fb-test_fb-test01-18b9b63288cdbd0446134799423b06e9d0c3541e2baacccd729035f92c879d7a.log: {"log":"name:eloncheng||fluent-bit-test|The current number is100\n","time":"2021-05-26T05:28:48.38284985Z","kubernetes":{"pod_name":"fb-test-pod","namespace_name":"fb-test","container_name":"fb-test01","docker_id":"3e767d61a3dcdb96898d09ef97ff463fa0120e463f36ee12aaf195ad4a365dcd","container_image":"wenchajun/test:v0.6"}}
```

打印日志记录如下：

|                          | 每秒输出50次日志 | 每秒输出500次日志 | 每秒输出800次日志 | 每秒输出900次日志 |
| ------------------------ | ---------------- | ----------------- | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 31200            | 301200            | 482002            | 541200            |
| 10分钟内共有（fluentd）  | 31200            | 301200            | 480804            | 541200            |
| 平均每秒收集(容器)       | 52               | 502               | 803.3             | 902               |
| 平均每秒收集（fluentd）  | 52               | 502               | 801.34            | 902               |

|                          | 每秒输出1000次日志 | 每秒输出1100次日志 |
| ------------------------ | ------------------ | ------------------ |
| 10分钟内共有（容器内部） | 602202             | 661200             |
| 10分钟内共有（fluentd）  | 560636             | 535364             |
| 平均每秒收集(容器内部)   | <u>1003.67</u>     | <u>1102</u>        |
| 平均每秒收集（fluentd）  | <u>934.39</u>      | <u>892.3</u>       |

|                          | 每秒输出700次日志 | 每秒输出750次日志 | 760    |      | 775    |      |      | 每秒输出800次日志 | 每秒输出900次日志 |
| ------------------------ | ----------------- | ----------------- | ------ | ---- | ------ | ---- | ---- | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 420000            | 450000            | 45600  |      | 46500  |      |      | 480000            | 540000            |
| 10分钟内共有             | 420000            | 450000            | 445605 |      | 456964 |      |      | 464422            | 529640            |
| 平均每秒收集(容器内部)   | 700               |                   |        |      |        |      |      |                   |                   |
| 平均每秒收集（fluentd）  |                   | 589.165           |        |      |        |      |      |                   |                   |
| 每秒输出数据量           |                   | 131.83kb          |        |      |        |      |      |                   |                   |









从这次测试中我们可以看出虽然将每次打印信息的数据量降为原来的1/4，但是每秒打印超过1000条的情况下，日志仍然丢失严重。主要原因在于CPU限制。

### 测试3：同时启动多个pod，测试fluent-bit：v1.7.3性能

对于多个Pod测试，在本次测试中，我们使用Deployment创建2个pod，控制pod中每个容器的打印速率，观察日志打印状态。在本次测试中信息输出大小为测试2中的大小。输出57字节

|                          | 每秒输出50次日志 | 每秒输出300次日志 | 每秒输出400次日志 | 每秒输出500次日志 |
| ------------------------ | ---------------- | ----------------- | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 62088            | 363004            | 482400            | 602400            |
| 10分钟内共有（fluentd）  | 62296            | 364939            | 481120            | 531257            |
| 平均每秒收集(容器)       | 103.48           | 605               | 804               | <u>1004</u>       |
| 平均每秒收集（fluentd）  | 103.82           | 608.2             | 801.9             | <u>885.4</u>      |

|                          | 每秒输出550次日志 | 每秒输出600次日志 |
| ------------------------ | ----------------- | ----------------- |
| 10分钟内共有（容器内部） | 662400            | 723604            |
| 10分钟内共有（fluentd）  | 494752            | 474423            |
| 平均每秒收集(容器)       | <u>1104</u>       | <u>1206.00</u>    |
| 平均每秒收集（fluentd）  | <u>824.6</u>      | <u>790.75</u>     |



|                          | 每秒输出300次日志 | 350    | 360    |      | 375    |      |      |      | 每秒输出400次日志 |
| ------------------------ | ----------------- | ------ | ------ | ---- | ------ | ---- | ---- | ---- | ----------------- |
| 10分钟内共有（容器内部） | 360000            | 420000 | 432000 |      | 450000 |      |      |      | 480000            |
| 10分钟内共有             | 360000            | 420000 | 432000 |      | 449204 |      |      |      | 478161            |
| 平均每秒收集(容器内部)   |                   |        |        |      |        |      |      |      |                   |
| 平均每秒收集（fluentd）  |                   |        |        |      |        |      |      |      |                   |
| 每秒输出数据量           |                   |        |        |      |        |      |      |      |                   |

故在单节点中，开启多个pod，每秒输出日志的总量并不会得到提升。

### 测试4：调整参数以确保信息不丢失

通过调整输出，将输出信息一次发送一条，1秒钟发送1000条，1秒钟发送1500条的情况下，查看elasticsearch-logging-data-0和1中es容器的资源使用情况，发现1s发送1000条资源使用量为0.29core，而1秒发送1500条情况下资源使用量为0.29-0.32core，内存消耗为2.29G，且es容器资源限制为CPU：4，初步排除es性能不够的影响，通过调整fluent-bit的CPU来查看日志收集情况

修改CPU限制仍然导致日志丢失，通过查看fluentd工作原理，如图所示，![](https://github.com/wenchajun/test/blob/master/images/1%20(2).png)

判断可能是数据来不及收集，于是修改Input.spec.tail.memBufLimit,将其默认值5MB改为20MB，该值为将数据追加到引擎时的内存限制。如果达到此限制，它将被暂停；刷新数据后，它将恢复。为了保障数据能及时传递，将每秒2000次日志设置为30MB，每秒2500次日志设置为60MB。在这数据输出大小采用测试1中的数据，在测试1中，数据达到每秒800条就已不能及时获取全部信息，所以从800开始测试。

|                                         | 800/s              | 1000/s              | 1500/s                   | 2000/s                   | 2500/s                   |
| --------------------------------------- | ------------------ | ------------------- | ------------------------ | ------------------------ | ------------------------ |
| 测试程序实际打印                        | 802                | 1002                | 1502                     | 2002                     | 2502                     |
| 10分钟内共有（容器内部）                | 477190             | 602202              | 901200                   | 1201200                  | 1489695                  |
| 10分钟内共有（fluentd）                 | 473539             | 602589              | 900747                   | 1154136                  | 1289339                  |
| 平均每秒收集(容器)                      | 795.316            | 1003.27             | 1502                     | 2002                     | <u>2482.8</u>            |
| 平均每秒收集（fluentd）                 | 795.3              | 1004.31             | 1501.24                  | 1923.56                  | <u>2148.89</u>           |
| fluent-bit资源使用情况（CPU）           | 0.11-0.12core      | 0.14-0.15core       | 0.21-0.22core            | 0.26-0.29core            | 0.32-0.35core            |
| fluent-bit资源使用情况（内存）          | 21.8-31.37Mi       | 51.84-55.71Mi       | 46.01-63.54Mi            | 58.11-88.66Mi            | 51.11-72.66Mi            |
| fluent-bit资源使用情况（网络流出/流入） | 20.21Mbps/2.87Mbps | 24.09Mbps/3.59MKbps | 35.55Mbps/5.5Mbps        | 41.67-46.68Mbps/7.09Mbps | 49.67-64.68Mbps/9.09Mbps |
| fluentd资源使用情况（CPU）              | 72-77m             | 87-88m              | 0.14-0.15core            | 0.16-0.17core            | 0.19-0.21core            |
| fluentd资源使用情况（内存）             | 139.28Mi           | 154.93Mi            | 212.39Mi                 | 265.48Mi                 | 275.48Mi                 |
| fluentd资源使用情况（网络流出/流入）    | 8.05Kbps/8.96Kbps  | 10.72Kbps/10.32Mbps | 20.7Kbps/15.94-17.87Mbps | 25.23kbps/20.56Mbps      | 30.23kbps/26.56Mbps      |

可以看到，调整大小后，fluent-bit性能得到了明显改善，而信息发送到达每秒2000条后，日志遗失率约为3.91%，每秒发送2500条时，日志遗失率为13.68%。所以当每秒日志量过大时，可以通过调整Input.spec.tail.memBufLimit来收集信息。



Input.spec.tail.memBufLimit=10mb，	N=2

|                          | 800    | 900                | 1000           | 1100               |      |      |      |      | 1200               |
| ------------------------ | ------ | ------------------ | -------------- | ------------------ | ---- | ---- | ---- | ---- | ------------------ |
| 10分钟内共有（容器内部） | 480000 | 540000             | 60000          | 660000             |      |      |      |      | 720000             |
| 10分钟内共有             | 480000 | 540000             | 60000          | 660000             |      |      |      |      | 713468             |
| 平均每秒收集(容器内部)   |        |                    |                |                    |      |      |      |      |                    |
| 平均每秒收集（fluentd）  |        |                    |                |                    |      |      |      |      |                    |
| 输出速率大小             |        |                    |                |                    |      |      |      |      |                    |
| fluent-bit输出输入       |        | 21.79Mbps/3.13Mbps | 25Mbps/3.6Mbps | 27.14Mbps/3.91Mbps |      |      |      |      | 30.07Mbps/4.33Mbps |

